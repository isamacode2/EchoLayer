<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whisper Intel</title>
<style>
body {
    font-family: -apple-system, sans-serif;
    text-align: center;
    padding: 40px;
}
button {
    padding: 20px;
    margin: 10px;
    font-size: 18px;
    border-radius: 12px;
    border: none;
}
.connect { background: #2ecc71; color: white; }
.disconnect { background: #e74c3c; color: white; }
.trigger { background: #3498db; color: white; }
</style>
</head>
<body>

<h1>Whisper Intel</h1>

<button id="connectBtn" class="connect">Connect</button>
<button id="triggerBtn" class="trigger" disabled>Think</button>

<script>
let pc;
let dc;
let localStream;
let audioElement = document.createElement("audio");
audioElement.autoplay = true;
audioElement.playsInline = true;

document.getElementById("connectBtn").onclick = async () => {
    if (!pc) {
        await connect();
    } else {
        disconnect();
    }
};

document.getElementById("triggerBtn").onclick = () => {
    if (dc && dc.readyState === "open") {
        dc.send(JSON.stringify({
            type: "response.create",
            response: {
                instructions: "Provide short tactical intelligence in English only."
            }
        }));
    }
};

async function connect() {
    try {

        if (!audioElement.parentNode) {
            document.body.appendChild(audioElement);
        }

        pc = new RTCPeerConnection({
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        });

        dc = pc.createDataChannel("oai-events");

        dc.onopen = () => {
            document.getElementById("triggerBtn").disabled = false;

            dc.send(JSON.stringify({
                type: "session.update",
                session: {
                    instructions: `
You are a professional tactical intelligence assistant.

STRICT RULES:
1. You MUST respond ONLY in English.
2. You MUST NEVER respond in Spanish.
3. If input is not English, translate internally and respond in English.
4. Do NOT mention language rules.
5. You do NOT have internet browsing capability.
6. Only use information from this session.
`,
                    input_audio_transcription: {
                        model: "gpt-4o-transcribe",
                        language: "en"
                    }
                }
            }));
        };

        pc.ontrack = (event) => {
            audioElement.srcObject = event.streams[0];
            audioElement.play().catch(() => {});
        };

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream);
        });

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        await new Promise(resolve => {
            if (pc.iceGatheringState === "complete") {
                resolve();
            } else {
                const checkState = () => {
                    if (pc.iceGatheringState === "complete") {
                        pc.removeEventListener("icegatheringstatechange", checkState);
                        resolve();
                    }
                };
                pc.addEventListener("icegatheringstatechange", checkState);
            }
        });

        const response = await fetch("/realtime", {
            method: "POST",
            headers: {
                "Content-Type": "application/sdp"
            },
            body: pc.localDescription.sdp
        });

        if (!response.ok) {
            throw new Error("Realtime endpoint failed: " + response.status);
        }

        const answerSDP = await response.text();

        await pc.setRemoteDescription({
            type: "answer",
            sdp: answerSDP
        });

        document.getElementById("connectBtn").innerText = "Disconnect";

    } catch (err) {
        alert("Connection failed: " + err.message);
        disconnect();
    }
}

function disconnect() {
    try {
        if (pc) pc.close();
    } catch {}

    pc = null;
    document.getElementById("triggerBtn").disabled = true;
    document.getElementById("connectBtn").innerText = "Connect";
}
</script>

</body>
</html>
