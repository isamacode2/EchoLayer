<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whisper Intel – Interview Assist</title>
<style>
body {
    font-family: -apple-system, sans-serif;
    text-align: center;
    padding: 40px;
}
button {
    padding: 20px;
    margin: 10px;
    font-size: 18px;
    border-radius: 12px;
    border: none;
}
.connect { background: #2ecc71; color: white; }
.disconnect { background: #e74c3c; color: white; }
.trigger { background: #3498db; color: white; }
</style>
</head>
<body>

<h1>Interview Assist Mode</h1>

<button id="connectBtn" class="connect">Connect</button>
<button id="triggerBtn" class="trigger" disabled>Assist</button>

<script>
let pc;
let dc;
let localStream;
let audioElement = document.createElement("audio");
audioElement.autoplay = true;
audioElement.playsInline = true;

const connectBtn = document.getElementById("connectBtn");
const triggerBtn = document.getElementById("triggerBtn");

connectBtn.onclick = async () => {
    if (!pc) {
        await connect();
    } else {
        disconnect();
    }
};

triggerBtn.onclick = () => {
    if (dc && dc.readyState === "open") {
        dc.send(JSON.stringify({
            type: "response.create",
            response: {
                instructions: `
You are operating in Interview Assist Mode.

STEP 1 — Identify question type:
- Behavioural
- Technical
- Strategic
- Problem-solving

If Behavioural:
Use concise STAR format:
- Situation (1 sentence)
- Task (1 sentence)
- Action (max 2 sentences)
- Result (1 measurable outcome)

If Technical:
- Direct answer first
- Short explanation
- One practical example

Rules:
- Maximum 5 sentences total
- No filler words
- Confident tone
- English only

End with:

LEADERSHIP EDGE:
[One strong sentence elevating ownership, initiative, or impact]
`
            }
        }));
    }
};

async function connect() {
    try {

        if (!audioElement.parentNode) {
            document.body.appendChild(audioElement);
        }

        pc = new RTCPeerConnection({
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        });

        dc = pc.createDataChannel("oai-events");

        dc.onopen = () => {
            triggerBtn.disabled = false;

            dc.send(JSON.stringify({
                type: "session.update",
                session: {
                    instructions: `
You are a covert real-time Interview Assistant.

Your mission is to enhance response quality instantly.

GLOBAL RULES:
1. Always respond in English.
2. Never switch languages.
3. Keep answers concise.
4. Structure behavioural answers using STAR.
5. Frame responses with leadership and ownership.
6. No disclaimers.
7. No unnecessary elaboration.
`,
                    input_audio_transcription: {
                        model: "gpt-4o-transcribe",
                        language: "en"
                    }
                }
            }));
        };

        dc.onmessage = (event) => {
            console.log("Realtime event:", event.data);
        };

        pc.ontrack = (event) => {
            audioElement.srcObject = event.streams[0];
            audioElement.play().catch(() => {});
        };

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream);
        });

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        await new Promise(resolve => {
            if (pc.iceGatheringState === "complete") {
                resolve();
            } else {
                const checkState = () => {
                    if (pc.iceGatheringState === "complete") {
                        pc.removeEventListener("icegatheringstatechange", checkState);
                        resolve();
                    }
                };
                pc.addEventListener("icegatheringstatechange", checkState);
            }
        });

        const response = await fetch("/realtime", {
            method: "POST",
            headers: {
                "Content-Type": "application/sdp"
            },
            body: pc.localDescription.sdp
        });

        if (!response.ok) {
            throw new Error("Realtime endpoint failed: " + response.status);
        }

        const answerSDP = await response.text();

        await pc.setRemoteDescription({
            type: "answer",
            sdp: answerSDP
        });

        connectBtn.innerText = "Disconnect";

    } catch (err) {
        alert("Connection failed: " + err.message);
        disconnect();
    }
}

function disconnect() {
    try {
        if (pc) pc.close();
    } catch {}

    pc = null;
    triggerBtn.disabled = true;
    connectBtn.innerText = "Connect";
}
</script>

</body>
</html>