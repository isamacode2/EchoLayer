<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whisper Intel</title>
<style>
body {
    font-family: -apple-system, sans-serif;
    text-align: center;
    padding: 40px;
}
button {
    padding: 20px;
    margin: 10px;
    font-size: 18px;
    border-radius: 12px;
    border: none;
}
.connect { background: #2ecc71; color: white; }
.disconnect { background: #e74c3c; color: white; }
.trigger { background: #3498db; color: white; }
</style>
</head>
<body>

<h1>Whisper Intel</h1>

<button id="connectBtn" class="connect">Connect</button>
<button id="triggerBtn" class="trigger" disabled>Think</button>

<script>
let pc;
let dc;
let localStream;
let audioElement = document.createElement("audio");
audioElement.autoplay = true;

document.getElementById("connectBtn").onclick = async () => {
    if (!pc) {
        await connect();
    } else {
        disconnect();
    }
};

document.getElementById("triggerBtn").onclick = () => {
    if (dc && dc.readyState === "open") {
        dc.send(JSON.stringify({
            type: "response.create",
            response: {
                instructions: "Provide short tactical intelligence."
            }
        }));
    }
};

async function connect() {
    pc = new RTCPeerConnection();

    dc = pc.createDataChannel("oai-events");

   dc.onopen = () => {
  console.log("Data channel open");

  document.getElementById("triggerBtn").disabled = false;

  // ðŸ”’ Force English
  dc.send(JSON.stringify({
    type: "session.update",
    session: {
      instructions: "You are a professional tactical assistant. Always respond in English only.",
      input_audio_transcription: {
        language: "en-GB"
      }
    }
  }));
};

    pc.ontrack = (event) => {
        audioElement.srcObject = event.streams[0];
    };

    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const response = await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview", {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + apiKey,
            "Content-Type": "application/sdp"
        },
        body: offer.sdp
    });

    const answerSDP = await response.text();

    await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });

    document.getElementById("connectBtn").innerText = "Disconnect";
}

function disconnect() {
    pc.close();
    pc = null;
    document.getElementById("triggerBtn").disabled = true;
    document.getElementById("connectBtn").innerText = "Connect";
}
</script>

</body>
</html>
